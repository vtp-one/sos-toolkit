meta:
  sos_version: v0.0.1
  system_name: sos-mongodb
  system_version: v0.0.1
  system_internal: service/sos_mongodb
  platform: default

namespace:
  image_tag: ${service.mongodb.meta.system_name}/${service.mongodb.meta.platform}:${service.mongodb.meta.system_version}
  setup: False
  runtime_name: ${service.mongodb.meta.system_name}
  project_name: ${service.mongodb.meta.system_name}
  network_name: mongodb_serve
  data_dir: /tmp/mongodb_data
  protocol: mongodb
  host: 0.0.0.0
  port: "27017"

action:
  setup:
    image_exists:
      tool: docker.image_exists
      context_map:
        - label: get image tag
          result: target
          data: service.mongodb.namespace.image_tag
      result_map:
        - label: set image exists result
          result: service.mongodb.namespace.setup
          data: result

    break:
      tool: context.runtime_break
      params:
        info_pass: MONGODB_SETUP BUILDER RUNNING
        info_break: MONGODB_SETUP BUILDER SKIPPED
        resolve:
          - label: if mongodb setup
            ctx_key: service.mongodb.namespace.setup
            valid: True
            comparison: equal
            raise_exc: False
        qualifier: all

    build:
      label: mongodb builder
      tool: docker.buildx_bake
      params:
        bake_file: bakefile.hcl
        bake_target: default
      context_map:
        - label: get version
          result: version
          data: service.mongodb.meta.system_version
        - label: get platform
          result: platform
          data: service.mongodb.meta.platform
        - label: build context_dir
          result: context_dir
          data:
            - source: service.mongodb.meta.system_path
              target: system_dir
            - source: null
              target: platform_dir
              default: platform
            - source: service.mongodb.meta.platform
              target: platform
            - source: null
              target: builder_dir
              default: builder
          path_join: True
        - label: get namespace
          result: namespace
          data: service.mongodb.meta.system_name

    setup_complete:
      tool: context.ctx_set
      params:
        obj: True
        ctx_key: service.mongodb.namespace.setup
        overwrite: True

  plugin:
    install:
      tool: context.tool_module
      context_map:
        - label: plugin_path
          result: target
          data:
            - target: root_path
              source: service.mongodb.meta.system_path
            - target: plugin_path
              source: null
              default: mongodb
          path_join: True

  up:
    container_exists:
      label: check if the mongodb container already exists
      tool: docker.container_exists
      disabled: True

    create_network:
      label: create mongodb network
      tool: docker.network_create
      context_map:
        - label: get network name
          result: name
          data: service.mongodb.namespace.network_name

    compose:
      tool: docker.compose_up
      params:
        profile: default
      context_map:
        - label: generate compose file target
          result: file
          data:
            - source: service.mongodb.meta.system_path
              target: system_dir
            - source: null
              target: platform_dir
              default: platform
            - source: service.mongodb.meta.platform
              target: platform
            - source: null
              target: compose_file
              default: docker-compose.yaml
          path_join: True
        - label: get project name
          result: project_name
          data: service.mongodb.namespace.project_name
        - label: generate env_map
          result: env_map
          data:
            - target: SYSTEM_NAME
              source: service.mongodb.namespace.runtime_name
            - target: IMAGE_TAG
              source: service.mongodb.namespace.image_tag
            - target: MONGODB_NETWORK
              source: service.mongodb.namespace.network_name
            - target: MONGODB_HOST
              source: service.mongodb.namespace.host
            - target: MONGODB_PORT
              source: service.mongodb.namespace.port
            - target: MONGODB_DATA_PATH
              source: service.mongodb.namespace.data_dir

    base_url:
      label: generate mongodb base base_url
      tool: context.ctx_set
      params:
        ctx_key: service.mongodb.namespace.base_url
        overwrite: True
      context_map:
        - label: generate url
          result: obj
          data:
            - target: protocol
              source: service.mongodb.namespace.protocol
            - target: host
              source: service.mongodb.namespace.runtime_name
            - target: port
              source: service.mongodb.namespace.port
          format_string: "{protocol}://{host}:{port}"

    service_address:
      tool: terminal.print_object
      params:
        horizontal_rule: True
      context_map:
        - label: generate service address
          result: obj
          data:
            - source: null
              target: preamble
              default: "MONGODB RUNNING ON:"
            - source: service.mongodb.namespace.base_url
              target: target
          format_string: "{preamble} {target}"

  down:
    compose:
      tool: docker.compose_down
      context_map:
        - label: get project name
          result: project_name
          data: service.mongodb.namespace.project_name

    remove_network:
      label: remove mongodb serve network
      tool: docker.network_remove
      context_map:
        - label: get network name
          result: name
          data: service.mongodb.namespace.network_name

